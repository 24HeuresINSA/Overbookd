.docker-publish:
  stage: docker-publish
  interruptible: true
  image: docker
  services:
    - name: docker:dind
      command: ["--experimental"]
  before_script:
    - apk update
    - apk add jq
    - VERSION_TAG=${VERSION_TAG_PREFIX}$(jq -r '.version' ./${SCOPE}/package.json)
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker load -i ${SCOPE}.tar
    - docker push $CI_REGISTRY_IMAGE/$SCOPE:$TAG
    - docker push $CI_REGISTRY_IMAGE/$SCOPE:$VERSION_TAG

mr_backend_publish:
  extends: .docker-publish
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - backend/**/*
    - when: never
  needs: ["backend_docker_build"]
  variables:
    SCOPE: backend
    VERSION_TAG_PREFIX: "mr_"
    TAG: $CI_COMMIT_SHORT_SHA

mr_frontend_publish:
  extends: .docker-publish
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - frontend/**/*
    - when: never
  needs: ["frontend_docker_build"]
  variables:
    SCOPE: frontend
    VERSION_TAG_PREFIX: "mr_"
    TAG: $CI_COMMIT_SHORT_SHA

preprod_backend_publish:
  extends: .docker-publish
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - backend/**/*
    - when: never
  needs: ["backend_docker_build"]
  variables:
    SCOPE: backend
    VERSION_TAG_PREFIX: "pre-prod_"
    TAG: "pre-prod"

preprod_frontend_publish:
  extends: .docker-publish
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - frontend/**/*
    - when: never
  needs: ["frontend_docker_build"]
  variables:
    SCOPE: frontend
    VERSION_TAG_PREFIX: "pre-prod_"
    TAG: "pre-prod"

prod_backend_publish:
  extends: .docker-publish
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - backend/**/*
      when: manual
    - when: never
  needs: ["backend_docker_build"]
  variables:
    SCOPE: backend
    VERSION_TAG_PREFIX: ""
    TAG: "latest"

prod_frontent_publish:
  extends: .docker-publish
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - frontend/**/*
      when: manual
    - when: never
  needs: ["frontend_docker_build"]
  variables:
    SCOPE: frontend
    VERSION_TAG_PREFIX: ""
    TAG: "latest"
