.check:
  stage: check
  interruptible: true

.security: &security
  stage: check
  needs: []
  interruptible: true
  rules:
    - if: '($CI_PIPELINE_SOURCE == "schedule") && ($SECURITY_SCAN  == "1")'
      when: always
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: always
    - when: never

license_scanning:
  <<: *security
  variables:
    LICENSE_FINDER_CLI_OPTS: "--aggregate_paths=web api"

nodejs-scan-sast:
  <<: *security

semgrep-sast:
  <<: *security

secret_detection:
  <<: *security


.lint:
  extends: .check
  image: node:16-alpine
  before_script:
    - apk update
    - apk add openssh git
    - eval $(ssh-agent -s)
    - mkdir ~/.ssh/
    - echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo "Host gitlab.com" >> ~/.ssh/config
    - echo "IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
    - echo "StrictHostKeyChecking no" >> ~/.ssh/config
    - git config user.email "dsi@24heures.org"
    - git config user.name "24-bot"
    - git remote remove ssh_origin || true  # Local repo state may be cached
    - git remote add ssh_origin "git@$CI_SERVER_HOST:$CI_PROJECT_PATH.git"
    - git fetch --all
    - git checkout -b $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME ssh_origin/$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
    - corepack enable
    - corepack prepare pnpm@latest-8 --activate
    - pnpm config set store-dir .pnpm-store
    - pnpm i


overbookd/web_lint:
  extends: .lint
  needs: [install]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - apps/web/**/*
    - when: never
  script:
    - pnpm run --filter @overbookd/web lint
    - "git commit -am 'style(Web): ✍ Linted web files' || true"
    - git push ssh_origin HEAD:$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME || true

overbookd/api_lint:
  extends: .lint
  image: node:18-alpine
  needs: [install]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - apps/api/**/*
    - when: never
  script:
    - pnpm run --filter @overbookd/api lint
    - "git commit -am 'style(Api): ✍ Linted api files' || true"
    - git push ssh_origin HEAD:$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME || true


overbookd/api_prune:
  extends: .check
  image: node:18-alpine
  needs: [install]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - apps/api/**/*
    - when: never
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest-8 --activate
    - pnpm config set store-dir .pnpm-store
    - pnpm i
  script:
    - pnpm run --filter @overbookd/api find-deadcode
