.test:
  extends: .setup-pnpm
  stage: test
  interruptible: true
  image: node:20.10.0-alpine
  variables:
    SHOULD_CHECK_EXIT_CODE: "true"
  script:
    - pnpm i
    - pnpm --filter "${PNPM_WORKSPACE}^..." run build
    - pnpm --filter "${PNPM_WORKSPACE}" run test:ci || UNIT_TEST_FAILED=true
    - |
      if [ "$SHOULD_CHECK_EXIT_CODE" == true ]; then
        [[ "$UNIT_TEST_FAILED" == true ]] &&  exit 1 || exit 0
      fi

overbookd/api_test:
  services:
    - name: postgres:15
      alias: integration-tests-prisma
  variables:
    POSTGRES_USER: prisma
    POSTGRES_PASSWORD: password
    POSTGRES_DB: tests
    DATABASE_URL: postgresql://prisma:password@integration-tests-prisma:5432/tests
    PNPM_WORKSPACE: "@overbookd/api"
    SHOULD_CHECK_EXIT_CODE: "false"
  extends: .test
  needs: [install]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - apps/api/**/*
        - pnpm-lock.yaml
    - when: never
  script:
    - !reference [.test, script]
    - pnpm --filter "${PNPM_WORKSPACE}" run prisma:migrate
    - pnpm --filter "${PNPM_WORKSPACE}" run prisma:seed
    - pnpm --filter "${PNPM_WORKSPACE}" run test:e2e:ci || E2E_TEST_FAILED=true
    - |
      [[ "$UNIT_TEST_FAILED" == true ||  "$E2E_TEST_FAILED" == true ]] &&  exit 1 || exit 0

  artifacts:
    when: always
    reports:
      junit:
        - apps/api/junit.xml
        - apps/api/junit-e2e.xml
      coverage_report:
        coverage_format: cobertura
        path: apps/api/coverage/cobertura-coverage.xml

overbookd/web_test:
  extends: .test
  needs: [install]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - apps/web/**/*
        - pnpm-lock.yaml
    - when: never
  variables:
    PNPM_WORKSPACE: "@overbookd/web"
  artifacts:
    when: always
    reports:
      junit: apps/web/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: apps/web/coverage/cobertura-coverage.xml

overbookd/libraries_test:
  extends: .test
  needs: [install, overbookd/libraries_build]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - libraries/**/*
        - pnpm-lock.yaml
    - when: never
  variables:
    PNPM_WORKSPACE: "{libraries/**}"
  artifacts:
    when: always
    reports:
      junit: libraries/*/junit.xml

overbookd/domains_test:
  extends: .test
  needs: [install, overbookd/domains_build]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - domains/**/*
        - pnpm-lock.yaml
    - when: never
  variables:
    PNPM_WORKSPACE: "{domains/**}"
  artifacts:
    when: always
    reports:
      junit: domains/*/junit.xml
