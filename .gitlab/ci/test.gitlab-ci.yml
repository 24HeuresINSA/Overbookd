.test:
  extends: .setup-pnpm
  stage: test
  interruptible: true
  image: node:16-alpine
  script:
    - pnpm i
    - pnpm run --filter ${PNPM_WORKSPACE} test:ci

overbookd/api_test:
  extends: .test
  needs: [install]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - apps/api/**/*
    - when: never
  variables:
    PNPM_WORKSPACE: "@overbookd/api"
  artifacts:
    when: always
    reports:
      junit: apps/api/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: apps/api/coverage/cobertura-coverage.xml

overbookd/web_test:
  extends: .test
  needs: [install]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - apps/web/**/*
    - when: never
  variables:
    PNPM_WORKSPACE: "@overbookd/web"
  artifacts:
    when: always
    reports:
      junit: apps/web/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: apps/web/coverage/cobertura-coverage.xml
