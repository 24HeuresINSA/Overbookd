<template>
  <div class="register">
    <v-img
      src="https://www.24heures.org/wp-content/uploads/2022/01/img_24h_46e_photoorga.jpg"
      class="img-background"
    ></v-img>
    <v-card class="register-card">
      <v-img
        class="register-illustration"
        src="https://www.24heures.org/wp-content/uploads/2022/01/img_24h_44e_benevoles_dosscene.jpg"
      >
        <v-card-title class="register-title"> 👋 Inscription 👋 </v-card-title>
      </v-img>
      <v-stepper v-model="step" vertical>
        <v-stepper-step :complete="step > 1" step="1" @click="step = 1">
          Devenir Bénévole
          <small>Tout ce qu'il faut savoir sur le festival</small>
        </v-stepper-step>

        <v-stepper-content step="1">
          <div v-safe-html="registerDescription"></div>
          <v-btn color="primary" @click="step = 2"> C'est parti ! 🚀 </v-btn>
          <v-btn text @click="returnToLogin"> Annuler </v-btn>
        </v-stepper-content>

        <v-stepper-step
          :complete="step > 2"
          step="2"
          :rules="presentationRules"
          @click="step = 2"
        >
          Présentation
          <small>Dis nous en un peu plus sur toi</small>
        </v-stepper-step>

        <v-stepper-content step="2">
          <v-form class="data dense personnal-data">
            <v-text-field
              v-model="firstname"
              label="Prénom*"
              required
              :rules="[rules.required]"
            ></v-text-field>
            <v-text-field v-model="nickname" label="Surnom"></v-text-field>
            <v-text-field
              v-model="lastname"
              label="Nom*"
              :rules="[rules.required]"
              required
            ></v-text-field>
            <v-text-field
              v-model="birthday"
              label="Date de naissance*"
              type="date"
              :rules="[
                rules.required,
                rules.birthdayMaxDate,
                rules.birthdayMinDate,
              ]"
            >
            </v-text-field>
          </v-form>
          <v-btn color="primary" @click="step = 3"> Vous savez tout 🕵️</v-btn>
          <v-btn text @click="step = 1"> Revenir</v-btn>
        </v-stepper-content>

        <v-stepper-step
          :complete="step > 3"
          step="3"
          :rules="contactRules"
          @click="step = 3"
        >
          Contact
          <small>Comment on reste connectés ?</small>
        </v-stepper-step>

        <v-stepper-content step="3">
          <v-form class="data contact-data">
            <v-text-field
              v-model="email"
              label="Email*"
              required
              hint="Pas d'adresse insa 🙏"
              :rules="[rules.required, rules.email, rules.insaEmail]"
              persistent-hint
            ></v-text-field>
            <v-text-field
              v-model="phone"
              label="Ton 06 ?*"
              required
              :rules="[rules.required, rules.mobilePhone]"
            ></v-text-field>
            <v-select
              v-model="teams"
              multiple
              label="Équipes"
              :items="comingFromTeams"
              item-text="name"
              item-value="code"
              clearable
              hint="Tu nous rejoins à plusieurs ?"
              persistent-hint
              :rules="[twoTeamsMaximumRule]"
            ></v-select>
            <v-textarea
              v-model="comment"
              label="Commentaire"
              hint="Laisse nous un petit mot. 💌"
              persistent-hint
            ></v-textarea>
          </v-form>
          <v-btn color="primary" @click="step = 4"> On se capte 🤙 </v-btn>
          <v-btn text @click="step = 2"> Revenir </v-btn>
        </v-stepper-content>

        <v-stepper-step step="4" @click="step = 4">
          Sécurité <small>Un mot de passe</small>
        </v-stepper-step>
        <v-stepper-content step="4">
          <v-form class="data security-data">
            <v-text-field
              v-model="password"
              type="password"
              label="Mot de passe*"
              required
              hint="Au moins une MAJUSCULE, minuscule, un chiffre, un caractères spécial et 12 caractères 🔒"
              persistent-hint
              :rules="[rules.password]"
            ></v-text-field>

            <v-text-field
              v-model="repeatPassword"
              type="password"
              label="Confirme ton mot de passe*"
              required
              :rules="[repeatPasswordRule]"
            ></v-text-field>
          </v-form>
          <v-btn color="primary" :disabled="isFormInvalid" @click="register">
            M'inscrire
          </v-btn>
          <v-btn text @click="step = 3"> Revenir </v-btn>
          <ul class="errors">
            <li
              v-for="reason in registerForm.reasons"
              :key="reason"
              class="error--text"
            >
              {{ reason }}
            </li>
          </ul>
        </v-stepper-content>
      </v-stepper>
    </v-card>
    <SnackNotificationContainer />
  </div>
</template>

<script lang="ts">
import Vue from "vue";
import SnackNotificationContainer from "~/components/molecules/snack/SnackNotificationContainer.vue";
import {
  BDE_CODE,
  KARNA_CODE,
  KFET_CODE,
  RegisterForm,
  STRASBOURG_CODE,
  TECKOS_CODE,
  TENDRESTIVAL_CODE,
  TeamCode,
  Teams,
  WOODSTOWER_CODE,
} from "@overbookd/registration";
import {
  InputRulesData,
  required,
  minDate,
  maxDate,
  isEmail,
  isInsaEmail,
  isMobilePhoneNumber,
  password,
  isSame,
  maxLength,
} from "~/utils/rules/input.rules";

interface RegisterData extends InputRulesData {
  step: number;
  firstname: string;
  lastname: string;
  nickname?: string;
  birthday: string;
  teams: Teams;
  phone: string;
  comment?: string;
  email: string;
  password: string;
  repeatPassword: string;
}

export default Vue.extend({
  name: "Register",
  auth: false,
  components: { SnackNotificationContainer },
  layout: "none",
  data(): RegisterData {
    return {
      step: 1,
      firstname: "",
      lastname: "",
      nickname: undefined,
      birthday: "2000-01-01",
      email: "",
      phone: "",
      comment: undefined,
      teams: [],
      password: "",
      repeatPassword: "",
      rules: {
        required: required,
        birthdayMinDate: minDate(new Date("1950-01-01")),
        birthdayMaxDate: maxDate(),
        email: isEmail,
        insaEmail: isInsaEmail,
        mobilePhone: isMobilePhoneNumber,
        password: password,
      },
    };
  },
  computed: {
    token(): string | undefined {
      const token = this.$route.query.token;
      if (Array.isArray(token)) return undefined;

      return token ?? undefined;
    },
    cleanComment(): string | undefined {
      if (!this.comment) return undefined;
      return this.comment;
    },
    cleanNickname(): string | undefined {
      if (!this.nickname) return undefined;
      return this.nickname;
    },
    registerForm(): RegisterForm {
      return this.commentAction(this.nicknameAction(RegisterForm.init()))
        .fillBirthdate(this.birthdayDate)
        .fillEmail(this.email)
        .fillFirstname(this.firstname)
        .fillLastname(this.lastname)
        .fillMobilePhone(this.phone)
        .fillTeams(this.teams)
        .fillPassword(this.password);
    },
    birthdayDate(): Date {
      return new Date(this.birthday);
    },
    comingFromTeams(): TeamCode[] {
      return [
        BDE_CODE,
        STRASBOURG_CODE,
        KFET_CODE,
        KARNA_CODE,
        WOODSTOWER_CODE,
        TECKOS_CODE,
        TENDRESTIVAL_CODE,
      ];
    },
    presentationRules(): (() => boolean | string)[] {
      return [
        () => this.step <= 2 || this.rules.required(this.firstname),
        () => this.step <= 2 || this.rules.required(this.lastname),
        () => this.step <= 2 || this.rules.required(this.birthday),
        () => this.step <= 2 || this.rules.birthdayMaxDate(this.birthday),
        () => this.step <= 2 || this.rules.birthdayMinDate(this.birthday),
      ];
    },
    contactRules(): (() => boolean | string)[] {
      return [
        () => this.step <= 3 || this.rules.required(this.email),
        () => this.step <= 3 || this.rules.required(this.phone),
        () => this.step <= 3 || this.rules.email(this.email),
        () => this.step <= 3 || this.rules.insaEmail(this.email),
        () => this.step <= 3 || this.rules.mobilePhone(this.phone),
      ];
    },
    securityRules(): (() => boolean | string)[] {
      return [
        () => this.step <= 3 || this.rules.required(this.password),
        () => this.step <= 3 || this.rules.password(this.password),
      ];
    },
    repeatPasswordRule(): (value: string | null) => boolean | string {
      return isSame(this.password);
    },
    twoTeamsMaximumRule(): (value: unknown[] | null) => boolean | string {
      return maxLength(2);
    },
    isFormInvalid(): boolean {
      return (
        this.presentationRules.some((rule) => rule() !== true) ||
        this.contactRules.some((rule) => rule() !== true) ||
        this.securityRules.some((rule) => rule() !== true) ||
        this.repeatPasswordRule(this.repeatPassword) !== true ||
        this.registerForm.reasons.length > 0
      );
    },
    registerDescription(): string {
      return this.$accessor.configuration.registerFormDescription;
    },
  },
  async created() {
    await this.$accessor.team.setTeamsInStore();
    await this.$accessor.configuration.fetchAll();
  },
  methods: {
    commentAction(form: RegisterForm) {
      if (this.cleanComment === undefined) return form.clearComment();
      return form.fillComment(this.cleanComment);
    },
    nicknameAction(form: RegisterForm) {
      if (this.cleanNickname === undefined) return form.clearNickname();
      return form.fillNickname(this.cleanNickname);
    },
    async register() {
      const res = await this.$accessor.registration.register({
        token: this.token,
        form: this.registerForm,
      });
      if (!res) return;
      await this.$auth.loginWith("local", {
        data: { email: this.email, password: this.password },
      });
      this.$router.push("/");
    },
    returnToLogin() {
      this.$router.push("/login");
    },
  },
});
</script>

<style scoped lang="scss">
.img-background {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 100%;
  padding: 0;
}

.register {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  height: 100%;
  width: 100%;

  &-card {
    max-width: 1000px;
    width: 100%;
  }

  &-illustration {
    height: 20vh;
    min-height: 100px;
    max-height: 350px;
  }

  &-title {
    color: #ffffff;
    position: absolute;
    width: 100%;
    bottom: 0px;
    background-color: rgba($color: #000000, $alpha: 0.3);
    justify-content: center;
  }

  .data {
    display: flex;
    flex-direction: column;
    gap: 10px;

    &.dense {
      gap: 0px;
    }
  }

  .errors {
    margin-top: 10px;
    font-size: 0.8rem;
  }
}
</style>
